<!DOCTYPE html>
<html>
<head>
    <title>Daily Sales Entry</title>

    <style>
        body {
            margin: 0;
            background: #000;
            font-family: Arial, sans-serif;
            color: #eee;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 15px;
        }

        .table-box {
            background: #2c2c2c;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(255,255,255,0.15);
            max-width: 1200px;
            margin: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #444;
            padding: 8px;
            text-align: center;
        }

        th {
            background: #111;
        }

        input, select {
            width: 95%;
            padding: 5px;
            border-radius: 5px;
            border: none;
        }

        .grand {
            background: #0f5132;
            color: #b6ffdd;
            font-weight: bold;
        }

        .status-pending {
            background-color: #c0392b;
            color: white;
        }

        .status-received {
            background-color: #2980b9;
            color: white;
        }

        .search-box {
            text-align: center;
            margin-bottom: 10px;
        }

        .search-box input {
            width: 200px;
            padding: 6px;
        }
    </style>
</head>
<body>

<h1>ðŸ“Š Daily Sales Entry</h1>

<div style="text-align:center; margin-bottom:15px;">
    <a href="/" style="
        padding:8px 16px;
        background:#198754;
        color:white;
        text-decoration:none;
        border-radius:6px;">
        â¬… Back to Home
    </a>
</div>


<div class="table-box">

    <!-- ðŸ” Date Search -->
    <div class="search-box">
        <label>Search Date: </label>
        <input type="date" id="searchDate">
        <button onclick="filterByDate()">Search</button>
    </div>

    <table id="reportTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Total</th>
                <th>Fuel</th>
                <th>Grand</th>
                <th>Credit</th>
                <th>Status</th>
            </tr>
        </thead>

        <tbody>

            <!-- âœ… Saved Records (Editable) -->
            {% for r in week_reports %}
            <tr class="data-row">
                <td>
                    <input type="text" class="date" value="{{ r.date|date:'Y-m-d' }}" readonly>

                    <input type="hidden" class="rid" value="{{ r.id }}">
                </td>

                <td><input type="number" class="total" value="{{ r.total_amount }}"></td>
                <td><input type="number" class="fuel" value="{{ r.fuel_expense }}"></td>
                <td><input type="text" class="grand" readonly></td>
                <td><input type="number" class="credit" value="{{ r.credit_amount }}"></td>

                <td>
                    <select class="status">
                        <option {% if r.status == "Pending" %}selected{% endif %}>Pending</option>
                        <option {% if r.status == "Received" %}selected{% endif %}>Received</option>
                    </select>
                </td>
            </tr>
            {% endfor %}

            <!-- âž• New Entry Row (Today) -->
            <tr class="data-row">
                <td>
                    <input type="text" class="date" value="{{ today|date:'Y-m-d' }}" readonly>

                    <input type="hidden" class="rid" value="">
                </td>

                <td><input type="number" class="total"></td>
                <td><input type="number" class="fuel"></td>
                <td><input type="text" class="grand" readonly></td>
                <td><input type="number" class="credit"></td>

                <td>
                    <select class="status">
                        <option>Pending</option>
                        <option>Received</option>
                    </select>
                </td>
            </tr>

        </tbody>
    </table>

</div>

<script>
// ðŸ” Setup all rows
document.querySelectorAll(".data-row").forEach(row => {

    const total = row.querySelector(".total");
    const fuel = row.querySelector(".fuel");
    const grand = row.querySelector(".grand");
    const credit = row.querySelector(".credit");
    const status = row.querySelector(".status");
    const rid = row.querySelector(".rid");
    const date = row.querySelector(".date");

    function calculate() {
        const t = parseFloat(total.value) || 0;
        const f = parseFloat(fuel.value) || 0;
        grand.value = t - f;
    }

    function updateStatusColor() {
        status.classList.remove("status-pending", "status-received");
        if (status.value === "Pending") {
            status.classList.add("status-pending");
        } else {
            status.classList.add("status-received");
        }
    }

    function autoSave() {
        const data = new FormData();
        data.append("id", rid.value);
        data.append("date", date.value);
        data.append("total", total.value);
        data.append("fuel", fuel.value);
        data.append("credit", credit.value);
        data.append("status", status.value);

        fetch("/save-report/", {
            method: "POST",
            body: data,
            headers: {
                "X-CSRFToken": getCookie("csrftoken")
            }
        });
    }

    total.addEventListener("input", () => { calculate(); autoSave(); });
    fuel.addEventListener("input", () => { calculate(); autoSave(); });
    credit.addEventListener("input", autoSave);
    status.addEventListener("change", () => { updateStatusColor(); autoSave(); });

    calculate();
    updateStatusColor();
});


// CSRF helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ðŸ” Date filter
function filterByDate() {
    const search = document.getElementById("searchDate").value;
    const rows = document.querySelectorAll(".data-row");

    rows.forEach(row => {
        const date = row.querySelector(".date").value;
        if (!search || date.includes(search)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
}
</script>

</body>
</html>
